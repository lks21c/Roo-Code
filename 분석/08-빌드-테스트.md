# 08. 빌드 및 테스트 시스템

## 개요

Roo-Code는 **Turbo** 기반의 모노레포 구조를 사용하며, 다양한 번들러와 테스트 프레임워크를 조합하여 효율적인 개발 환경을 구축합니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                         Turbo (빌드 오케스트레이션)                │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   esbuild    │  │     Vite     │  │     tsup     │          │
│  │ (Extension)  │  │  (WebView)   │  │  (Libraries) │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
├─────────────────────────────────────────────────────────────────┤
│                    Vitest (단위 테스트)                          │
├─────────────────────────────────────────────────────────────────┤
│               pnpm workspace (패키지 관리)                       │
└─────────────────────────────────────────────────────────────────┘
```

## 1. 모노레포 구조

### 1.1 pnpm 워크스페이스 설정

```yaml
# pnpm-workspace.yaml
packages:
    - "src"          # VSCode Extension 메인
    - "webview-ui"   # React WebView
    - "apps/*"       # 앱 패키지들
    - "packages/*"   # 공유 라이브러리
```

### 1.2 패키지 의존성 그래프

```
┌────────────────────────────────────────────────────────────────┐
│                      src (roo-cline)                           │
│                   VSCode Extension 메인                         │
├────────────────────────────────────────────────────────────────┤
│  의존성:                                                        │
│  ├── @roo-code/types     (타입 정의)                           │
│  ├── @roo-code/ipc       (IPC 통신)                            │
│  ├── @roo-code/cloud     (클라우드 서비스)                      │
│  ├── @roo-code/telemetry (텔레메트리)                          │
│  └── @roo-code/build     (빌드 유틸리티)                        │
└────────────────────────────────────────────────────────────────┘
           │
           ▼
┌────────────────────────────────────────────────────────────────┐
│                   packages/ (공유 패키지)                       │
├────────────────┬───────────────┬───────────────┬───────────────┤
│     types      │      ipc      │   telemetry   │    build      │
│  타입 + Zod    │  node-ipc     │   PostHog     │  esbuild 유틸 │
│    스키마      │  클라이언트   │   클라이언트  │   + 복사 함수 │
├────────────────┴───────────────┴───────────────┴───────────────┤
│  config-eslint    │   config-typescript                        │
│  ESLint 설정      │   TypeScript 설정 (base, cjs, vscode 등)   │
└────────────────────────────────────────────────────────────────┘
```

### 1.3 패키지별 역할

| 패키지 | 역할 | 빌드 도구 |
|--------|------|----------|
| `@roo-code/types` | 공유 타입 정의 + Zod 스키마 | tsup |
| `@roo-code/ipc` | IPC 서버/클라이언트 | TypeScript |
| `@roo-code/build` | esbuild 유틸리티 함수 | TypeScript |
| `@roo-code/telemetry` | PostHog 텔레메트리 | TypeScript |
| `@roo-code/cloud` | 클라우드 API 클라이언트 | TypeScript |
| `@roo-code/config-eslint` | 공유 ESLint 설정 | - |
| `@roo-code/config-typescript` | 공유 TypeScript 설정 | - |

## 2. Turbo 빌드 시스템

### 2.1 turbo.json 설정

```json
{
  "$schema": "https://turbo.build/schema.json",
  "tasks": {
    "lint": {},
    "check-types": {},
    "test": {
      "dependsOn": ["@roo-code/types#build"]
    },
    "format": {},
    "clean": {
      "cache": false
    },
    "build": {
      "outputs": ["dist/**"],
      "inputs": ["src/**", "package.json", "tsconfig.json", "tsup.config.ts", "vite.config.ts"]
    },
    "watch:tsc": {
      "cache": false
    }
  }
}
```

### 2.2 주요 명령어

```bash
# 루트 package.json에 정의된 스크립트
pnpm lint          # 모든 패키지 린트
pnpm check-types   # 타입 체크
pnpm test          # 테스트 실행
pnpm build         # 모든 패키지 빌드
pnpm clean         # 빌드 결과물 정리

# VSIX 패키지 생성
pnpm vsix          # 프로덕션 VSIX
pnpm vsix:nightly  # 나이틀리 VSIX
```

### 2.3 빌드 의존성 체인

```
@roo-code/types#build
        │
        ▼
   test (모든 패키지)
        │
        ▼
   bundle (Extension)
        │
        ▼
   vsix (패키지 생성)
```

## 3. 번들링 시스템

### 3.1 esbuild (Extension)

VSCode Extension은 esbuild로 번들링됩니다.

```javascript
// src/esbuild.mjs (핵심 구조)
import * as esbuild from "esbuild"
import { copyPaths, copyWasms, copyLocales } from "@roo-code/build"

const buildOptions = {
  bundle: true,
  minify: production,
  sourcemap: true,
  format: "cjs",
  platform: "node",
}

// Extension 메인 빌드
const extensionConfig = {
  ...buildOptions,
  entryPoints: ["extension.ts"],
  outfile: "dist/extension.js",
  external: ["vscode"],  // vscode API는 외부 의존성
}

// Worker 빌드 (토큰 카운팅)
const workerConfig = {
  ...buildOptions,
  entryPoints: ["workers/countTokens.ts"],
  outdir: "dist/workers",
}
```

### 3.2 esbuild 플러그인 시스템

```javascript
// 빌드 후 파일 복사 플러그인
const plugins = [
  {
    name: "copyFiles",
    setup(build) {
      build.onEnd(() => {
        copyPaths([
          ["../README.md", "README.md"],
          ["../CHANGELOG.md", "CHANGELOG.md"],
          ["../.env", ".env", { optional: true }],
          // vscode-material-icons, audio 파일 등
        ], srcDir, buildDir)
      })
    },
  },
  {
    name: "copyWasms",
    setup(build) {
      build.onEnd(() => copyWasms(srcDir, distDir))
    },
  },
  {
    name: "copyLocales",
    setup(build) {
      build.onEnd(() => copyLocales(srcDir, distDir))
    },
  },
]
```

### 3.3 @roo-code/build 유틸리티

```typescript
// packages/build/src/esbuild.ts

// 파일/디렉토리 복사 (옵션 지원)
export function copyPaths(
  copyPaths: [string, string, CopyPathOptions?][],
  srcDir: string,
  dstDir: string
) {
  copyPaths.forEach(([srcRelPath, dstRelPath, options = {}]) => {
    // 디렉토리면 재귀 복사, 파일이면 단일 복사
    // optional: true면 파일 없어도 에러 무시
  })
}

// WASM 파일 복사 (tiktoken, tree-sitter)
export function copyWasms(srcDir: string, distDir: string): void {
  // tiktoken_bg.wasm
  // tree-sitter.wasm
  // tree-sitter-wasms/out/*.wasm (모든 언어)
}

// 로케일 파일 복사 + 워처 설정
export function copyLocales(srcDir: string, distDir: string): void
export function setupLocaleWatcher(srcDir: string, distDir: string)
```

### 3.4 Vite (WebView)

WebView는 Vite + React로 빌드됩니다.

```typescript
// webview-ui/vite.config.ts
import { defineConfig } from "vite"
import react from "@vitejs/plugin-react"
import tailwindcss from "@tailwindcss/vite"

export default defineConfig(({ mode }) => ({
  plugins: [
    react(),
    tailwindcss(),
    persistPortPlugin(),    // 개발 서버 포트 저장
    wasmPlugin(),           // WASM 로더
    sourcemapPlugin(),      // 소스맵 처리
  ],

  resolve: {
    alias: {
      "@": resolve(__dirname, "./src"),
      "@roo": resolve(__dirname, "../src/shared"),  // 공유 코드 참조
    },
  },

  build: {
    outDir: "../src/webview-ui/build",
    rollupOptions: {
      input: {
        index: resolve(__dirname, "index.html"),
        "browser-panel": resolve(__dirname, "browser-panel.html"),
      },
      output: {
        // mermaid 번들 분리 (큰 의존성)
        manualChunks: (id) => {
          if (id.includes("mermaid") || id.includes("dagre")) {
            return "mermaid-bundle"
          }
        },
      },
    },
  },
}))
```

### 3.5 tsup (라이브러리 패키지)

공유 패키지들은 tsup으로 빌드됩니다.

```typescript
// packages/types/tsup.config.ts
import { defineConfig } from "tsup"

export default defineConfig({
  entry: ["src/index.ts"],
  format: ["cjs", "esm"],    // CommonJS + ESM 동시 출력
  dts: true,                  // 타입 정의 생성
  splitting: false,
  sourcemap: true,
  clean: true,
  outDir: "dist",
})
```

### 3.6 타입 패키지 export 패턴

```json
// packages/types/package.json
{
  "name": "@roo-code/types",
  "type": "module",
  "main": "./dist/index.cjs",
  "exports": {
    ".": {
      "types": "./src/index.ts",      // 개발 시 소스 직접 참조
      "import": "./src/index.ts",
      "require": {
        "types": "./dist/index.d.cts",
        "default": "./dist/index.cjs"
      }
    }
  }
}
```

## 4. 테스트 시스템

### 4.1 Vitest 설정

```typescript
// src/vitest.config.ts
import { defineConfig } from "vitest/config"
import path from "path"

export default defineConfig({
  test: {
    globals: true,           // describe, it 전역 사용
    setupFiles: ["./vitest.setup.ts"],
    watch: false,
    testTimeout: 20_000,
    hookTimeout: 20_000,
  },
  resolve: {
    alias: {
      vscode: path.resolve(__dirname, "./__mocks__/vscode.js"),
    },
  },
})
```

### 4.2 테스트 셋업

```typescript
// src/vitest.setup.ts
import nock from "nock"
import "./utils/path"  // String.prototype.toPosix() 확장

// 기본적으로 네트워크 요청 차단
nock.disableNetConnect()

export function allowNetConnect(host?: string | RegExp) {
  if (host) {
    nock.enableNetConnect(host)
  } else {
    nock.enableNetConnect()
  }
}

// 전역 모킹
global.structuredClone = global.structuredClone ||
  ((obj: any) => JSON.parse(JSON.stringify(obj)))
```

### 4.3 VSCode API 모킹

```javascript
// src/__mocks__/vscode.js
const mockEventEmitter = () => ({
  event: () => () => {},
  fire: () => {},
  dispose: () => {},
})

export const workspace = {
  workspaceFolders: [],
  getWorkspaceFolder: () => null,
  getConfiguration: () => ({
    get: (key, defaultValue) => defaultValue,
  }),
  createFileSystemWatcher: () => ({
    onDidCreate: () => mockDisposable,
    onDidChange: () => mockDisposable,
    onDidDelete: () => mockDisposable,
    dispose: () => {},
  }),
  fs: {
    readFile: () => Promise.resolve(new Uint8Array()),
    writeFile: () => Promise.resolve(),
  },
}

export const window = {
  activeTextEditor: null,
  showErrorMessage: () => Promise.resolve(),
  showInformationMessage: () => Promise.resolve(),
  createOutputChannel: () => ({
    appendLine: () => {},
    show: () => {},
  }),
  createTerminal: () => ({
    name: "Roo Code",
    processId: Promise.resolve(123),
    sendText: () => {},
  }),
}

export const commands = {
  registerCommand: () => mockDisposable,
  executeCommand: () => Promise.resolve(),
}

export const Uri = {
  file: (path) => ({ fsPath: path, path, scheme: "file" }),
  parse: (path) => ({ fsPath: path, path, scheme: "file" }),
}

// Range, Position, Selection 클래스 등...
```

### 4.4 테스트 작성 패턴

```typescript
// src/core/checkpoints/__tests__/checkpoint.test.ts
import { describe, it, expect, vi, beforeEach, afterEach } from "vitest"

// 의존성 모킹
vi.mock("vscode", () => ({
  window: {
    showErrorMessage: vi.fn(),
    showInformationMessage: vi.fn(),
  },
  Uri: {
    file: vi.fn((path: string) => ({ fsPath: path })),
  },
}))

vi.mock("@roo-code/telemetry", () => ({
  TelemetryService: {
    instance: {
      captureCheckpointCreated: vi.fn(),
    },
  },
}))

describe("Checkpoint functionality", () => {
  let mockProvider: any
  let mockTask: any
  let mockCheckpointService: any

  beforeEach(async () => {
    mockCheckpointService = {
      isInitialized: true,
      saveCheckpoint: vi.fn().mockResolvedValue({ commit: "test-hash" }),
      restoreCheckpoint: vi.fn().mockResolvedValue(undefined),
      getDiff: vi.fn().mockResolvedValue([]),
    }

    mockTask = {
      taskId: "test-task-id",
      enableCheckpoints: true,
      checkpointService: mockCheckpointService,
    }
  })

  afterEach(() => {
    vi.clearAllMocks()
  })

  describe("checkpointSave", () => {
    it("should save checkpoint successfully", async () => {
      const result = await checkpointSave(mockTask, true)

      expect(mockCheckpointService.saveCheckpoint).toHaveBeenCalledWith(
        expect.stringContaining("Task: test-task-id"),
        { allowEmpty: true, suppressMessage: false }
      )
      expect(result).toEqual({ commit: "test-hash" })
    })

    it("should handle errors gracefully", async () => {
      mockCheckpointService.saveCheckpoint.mockRejectedValue(
        new Error("Save failed")
      )

      const result = await checkpointSave(mockTask)

      expect(result).toBeUndefined()
      expect(mockTask.enableCheckpoints).toBe(false)
    })
  })
})
```

### 4.5 테스트 디렉토리 구조

```
src/
├── __mocks__/
│   └── vscode.js           # VSCode API 모킹
├── vitest.config.ts        # Vitest 설정
├── vitest.setup.ts         # 테스트 셋업
├── core/
│   ├── checkpoints/
│   │   └── __tests__/
│   │       └── checkpoint.test.ts
│   ├── task/
│   │   └── __tests__/
│   │       ├── Task.dispose.test.ts
│   │       └── Task.throttle.test.ts
│   └── tools/
│       └── __tests__/
│           └── generateImageTool.test.ts
└── utils/
    └── __tests__/
        └── safeWriteJson.test.ts
```

## 5. TypeScript 설정

### 5.1 공유 설정 패턴

```json
// packages/config-typescript/base.json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "resolveJsonModule": true
  }
}
```

```json
// packages/config-typescript/vscode-library.json
{
  "extends": "./base.json",
  "compilerOptions": {
    "lib": ["ES2022"],
    "declaration": true,
    "declarationMap": true,
    "composite": true
  }
}
```

### 5.2 패키지별 tsconfig

```json
// src/tsconfig.json
{
  "extends": "@roo-code/config-typescript/vscode-library.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./",
    "types": ["node", "vscode"]
  },
  "include": ["**/*.ts"],
  "exclude": ["node_modules", "dist", "__tests__"]
}
```

## 6. CI/CD 파이프라인

### 6.1 빌드 순서

```yaml
# 추천 CI 파이프라인 순서
jobs:
  build:
    steps:
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Type check
        run: pnpm check-types

      - name: Test
        run: pnpm test

      - name: Build packages
        run: pnpm build

      - name: Bundle extension
        run: pnpm bundle

      - name: Create VSIX
        run: pnpm vsix
```

### 6.2 Changeset 버전 관리

```bash
# 버전 범프 및 CHANGELOG 업데이트
pnpm changeset:version

# NPM 패키지 배포 (@roo-code/types)
pnpm npm:publish:types
```

## 7. Python/Jupyter 적용

### 7.1 권장 빌드 도구 매핑

| Roo-Code | Python/Jupyter |
|----------|----------------|
| pnpm workspace | Poetry/PDM workspace |
| Turbo | Taskfile/Make/Nox |
| esbuild | PyInstaller/Nuitka |
| Vite | Webpack (JupyterLab) |
| tsup | setuptools/hatchling |
| Vitest | pytest |

### 7.2 Python 모노레포 구조

```python
# pyproject.toml (루트)
[tool.poetry]
name = "hdsp-agent"
version = "0.1.0"

[tool.poetry.dependencies]
python = "^3.10"

[tool.poetry.group.dev.dependencies]
pytest = "^8.0"
pytest-asyncio = "^0.23"
nox = "^2024.3"

# workspace 패키지
[tool.poetry.packages]
include = [
    { from = "packages", include = "hdsp_types" },
    { from = "packages", include = "hdsp_kernel" },
]
```

### 7.3 pytest 설정

```python
# pyproject.toml
[tool.pytest.ini_options]
testpaths = ["tests"]
asyncio_mode = "auto"
filterwarnings = ["ignore::DeprecationWarning"]

# 마커 정의
markers = [
    "slow: marks tests as slow",
    "integration: marks tests as integration tests",
]
```

### 7.4 Nox 빌드 자동화

```python
# noxfile.py
import nox

@nox.session
def lint(session):
    """Run linting."""
    session.install("ruff")
    session.run("ruff", "check", ".")

@nox.session
def typecheck(session):
    """Run type checking."""
    session.install("mypy", ".")
    session.run("mypy", "src")

@nox.session
def test(session):
    """Run tests."""
    session.install("pytest", "pytest-asyncio", ".")
    session.run("pytest", "-v")

@nox.session
def build(session):
    """Build packages."""
    session.install("build")
    session.run("python", "-m", "build")

# 전체 빌드 파이프라인
@nox.session
def ci(session):
    """Run full CI pipeline."""
    session.notify("lint")
    session.notify("typecheck")
    session.notify("test")
    session.notify("build")
```

### 7.5 JupyterLab Extension 빌드

```python
# pyproject.toml (JupyterLab Extension)
[build-system]
requires = [
    "hatchling>=1.5.0",
    "jupyterlab>=4.0.0,<5",
    "hatch-nodejs-version>=0.3.2",
]
build-backend = "hatchling.build"

[tool.hatch.build.targets.wheel.shared-data]
"hdsp_agent/labextension" = "share/jupyter/labextensions/hdsp-agent"
```

```javascript
// package.json (JupyterLab Extension의 frontend 부분)
{
  "name": "hdsp-agent",
  "version": "0.1.0",
  "scripts": {
    "build": "jlpm build:lib && jlpm build:labextension",
    "build:lib": "tsc --sourceMap",
    "build:labextension": "jupyter labextension build .",
    "watch": "run-p watch:src watch:labextension",
    "watch:src": "tsc -w --sourceMap",
    "watch:labextension": "jupyter labextension watch ."
  }
}
```

### 7.6 pytest 모킹 패턴

```python
# tests/conftest.py
import pytest
from unittest.mock import MagicMock, AsyncMock, patch

@pytest.fixture
def mock_kernel():
    """Mock Jupyter kernel."""
    kernel = MagicMock()
    kernel.execute = AsyncMock(return_value={
        "status": "ok",
        "execution_count": 1
    })
    return kernel

@pytest.fixture
def mock_notebook():
    """Mock Jupyter notebook."""
    notebook = {
        "cells": [
            {
                "cell_type": "code",
                "source": "print('hello')",
                "outputs": []
            }
        ],
        "metadata": {
            "kernelspec": {"name": "python3"}
        }
    }
    return notebook

# 비동기 테스트 픽스처
@pytest.fixture
async def agent(mock_kernel):
    """Create agent with mocked kernel."""
    from hdsp_agent import Agent

    with patch("hdsp_agent.get_kernel", return_value=mock_kernel):
        agent = Agent()
        await agent.initialize()
        yield agent
        await agent.cleanup()
```

### 7.7 테스트 작성 예시

```python
# tests/test_agent.py
import pytest
from unittest.mock import AsyncMock, patch

class TestAgent:
    """Agent 테스트."""

    @pytest.mark.asyncio
    async def test_execute_code(self, agent, mock_kernel):
        """코드 실행 테스트."""
        result = await agent.execute_code("print('hello')")

        mock_kernel.execute.assert_called_once_with(
            "print('hello')",
            silent=False
        )
        assert result["status"] == "ok"

    @pytest.mark.asyncio
    async def test_tool_execution(self, agent):
        """도구 실행 테스트."""
        result = await agent.execute_tool(
            "read_file",
            {"path": "/tmp/test.txt"}
        )

        assert "content" in result

    @pytest.mark.asyncio
    async def test_error_handling(self, agent, mock_kernel):
        """에러 처리 테스트."""
        mock_kernel.execute.side_effect = Exception("Kernel error")

        with pytest.raises(Exception, match="Kernel error"):
            await agent.execute_code("invalid code")

class TestCheckpoint:
    """체크포인트 테스트."""

    @pytest.fixture
    def checkpoint_service(self, tmp_path):
        """체크포인트 서비스 픽스처."""
        from hdsp_agent.checkpoints import NotebookCheckpointService
        return NotebookCheckpointService(tmp_path)

    @pytest.mark.asyncio
    async def test_save_checkpoint(self, checkpoint_service):
        """체크포인트 저장 테스트."""
        result = await checkpoint_service.save("test message")

        assert "commit" in result
        assert result["commit"] is not None

    @pytest.mark.asyncio
    async def test_restore_checkpoint(self, checkpoint_service):
        """체크포인트 복원 테스트."""
        save_result = await checkpoint_service.save("before change")

        # 변경 후 복원
        await checkpoint_service.restore(save_result["commit"])

        # 복원 확인
        assert checkpoint_service.current_state == "before change"
```

### 7.8 공유 패키지 구조

```
hdsp-agent/
├── pyproject.toml           # 루트 프로젝트 설정
├── noxfile.py               # 빌드 자동화
├── packages/
│   ├── hdsp_types/          # 공유 타입 (Pydantic 모델)
│   │   ├── pyproject.toml
│   │   ├── src/
│   │   │   └── hdsp_types/
│   │   │       ├── __init__.py
│   │   │       ├── message.py
│   │   │       └── config.py
│   │   └── tests/
│   ├── hdsp_kernel/         # 커널 통신
│   │   ├── pyproject.toml
│   │   └── src/
│   └── hdsp_tools/          # 도구 시스템
│       ├── pyproject.toml
│       └── src/
├── src/
│   └── hdsp_agent/          # 메인 에이전트
│       ├── __init__.py
│       ├── agent.py
│       └── checkpoints.py
├── tests/
│   ├── conftest.py
│   └── test_agent.py
└── labextension/            # JupyterLab Extension
    ├── package.json
    └── src/
```

## 8. 핵심 인사이트

### 8.1 Turbo의 장점

1. **태스크 의존성 관리**: `dependsOn`으로 빌드 순서 자동화
2. **증분 빌드**: 변경된 패키지만 재빌드
3. **병렬 실행**: 독립적인 태스크 동시 실행
4. **캐싱**: 빌드 결과 캐싱으로 재빌드 시간 단축

### 8.2 다중 번들러 전략

- **Extension (Node.js)**: esbuild - 빠른 번들링, CJS 출력
- **WebView (Browser)**: Vite - HMR, 최적화된 프로덕션 빌드
- **라이브러리**: tsup - ESM/CJS 동시 출력, 타입 정의 생성

### 8.3 테스트 격리 패턴

```typescript
// VSCode API는 완전히 모킹
vi.mock("vscode", () => ({ /* mock implementation */ }))

// 네트워크는 기본 차단
nock.disableNetConnect()

// 각 테스트 후 모킹 초기화
afterEach(() => {
  vi.clearAllMocks()
})
```

### 8.4 Jupyter 적용 시 고려사항

1. **커널 모킹**: Jupyter 커널 API 완전 모킹 필요
2. **비동기 테스트**: `pytest-asyncio` 필수
3. **상태 격리**: 노트북 상태 테스트 간 격리
4. **통합 테스트**: 실제 커널과의 통합 테스트 분리

## 9. 참고 파일

| 파일 | 역할 | 줄 수 |
|------|------|-------|
| `turbo.json` | Turbo 빌드 설정 | 22 |
| `pnpm-workspace.yaml` | 워크스페이스 정의 | 6 |
| `src/esbuild.mjs` | Extension 빌드 스크립트 | 134 |
| `webview-ui/vite.config.ts` | WebView 빌드 설정 | 186 |
| `packages/types/tsup.config.ts` | 라이브러리 빌드 설정 | 12 |
| `src/vitest.config.ts` | Vitest 설정 | 24 |
| `src/vitest.setup.ts` | 테스트 셋업 | 18 |
| `src/__mocks__/vscode.js` | VSCode API 모킹 | 175 |
| `packages/build/src/esbuild.ts` | 빌드 유틸리티 | 287 |
